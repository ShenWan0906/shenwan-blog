---
import BackToTop from "@components/control/BackToTop.astro";
import Footer from "@components/Footer.astro";
import Navbar from "@components/Navbar.astro";
import SideBar from "@components/widget/SideBar.astro";
import type { MarkdownHeading } from "astro";
import { Icon } from "astro-icon/components";
import ImageWrapper from "../components/misc/ImageWrapper.astro";
import TOC from "../components/widget/TOC.astro";
import { siteConfig } from "../config";
import {
  BANNER_HEIGHT,
  BANNER_HEIGHT_EXTEND,
  MAIN_PANEL_OVERLAPS_BANNER_HEIGHT,
} from "../constants/constants";
import Layout from "./Layout.astro";

/* âœ… 1. æ–°å¢å¼•ç”¨ï¼šå¼•å…¥å›¾ç‰‡ç»„ä»¶å’Œå›¾ç‰‡æ–‡ä»¶ */
import ImageWidget from "../components/widget/ImageWidget.astro";
import mpQrImg from "../constants/images/mp_qr.jpg";
import miniQrImg from "../constants/images/mini_qr.jpg";

import coverImg from "../constants/images/cover.jpeg";

interface Props {
  title?: string;
  banner?: string;
  description?: string;
  lang?: string;
  setOGTypeArticle?: boolean;
  headings?: MarkdownHeading[];
}

const {
  title,
  banner,
  description,
  lang,
  setOGTypeArticle,
  headings = [],
} = Astro.props;
const hasBannerCredit =
  siteConfig.banner.enable && siteConfig.banner.credit.enable;
const hasBannerLink = !!siteConfig.banner.credit.url;

const mainPanelTop = siteConfig.banner.enable
  ? `calc(${BANNER_HEIGHT}vh - ${MAIN_PANEL_OVERLAPS_BANNER_HEIGHT}rem)`
  : "5.5rem";
---

<Layout
  title={title}
  banner={banner}
  description={description}
  lang={lang}
  setOGTypeArticle={setOGTypeArticle}
>
  <slot slot="head" name="head" />
  <div
    id="top-row"
    class="z-50 pointer-events-none relative transition-all duration-700 max-w-[var(--page-width)] px-0 md:px-4 mx-auto"
    class:list={[""]}
  >
    <div
      id="navbar-wrapper"
      class="pointer-events-auto sticky top-0 transition-all"
    >
      <Navbar />
    </div>
  </div>

  {
    siteConfig.banner.enable && (
      <div
        id="banner-wrapper"
        class={`absolute z-10 w-full transition duration-700 overflow-hidden`}
        style={`top: -${BANNER_HEIGHT_EXTEND}vh`}
      >
        <ImageWrapper
          id="banner"
          alt="Banner image of the blog"
          class:list={[
            "object-cover h-full transition duration-700 opacity-0 scale-105",
          ]}
          src={siteConfig.banner.src}
          position={siteConfig.banner.position}
        />
      </div>
    )
  }

  <div
    class="absolute w-full z-30 pointer-events-none"
    style={`top: ${mainPanelTop}`}
  >
    <div class="relative max-w-[var(--page-width)] mx-auto pointer-events-auto">
      <div
        id="main-grid"
        class="transition duration-700 w-full left-0 right-0 grid grid-cols-[17.5rem_auto] grid-rows-[auto_1fr_auto]
        lg:grid-rows-[auto] xl:grid-cols-[17.5rem_auto_17.5rem]
        mx-auto gap-4 px-0 md:px-4"
      >
        {
          hasBannerCredit && (
            <a
              href={siteConfig.banner.credit.url}
              id="banner-credit"
              target="_blank"
              rel="noopener"
              aria-label="Visit image source"
              class:list={[
                "group onload-animation transition-all absolute flex justify-center items-center rounded-full " +
                  "px-3 right-4 -top-[3.25rem] bg-black/60 hover:bg-black/70 h-9",
                { "hover:pr-9 active:bg-black/80": hasBannerLink },
              ]}
            >
              <Icon
                class="text-white/75 text-[1.25rem] mr-1"
                name="material-symbols:copyright-outline-rounded"
              />
              <div class="text-white/75 text-xs">
                {siteConfig.banner.credit.text}
              </div>
              <Icon
                class:list={[
                  "transition absolute text-[oklch(0.75_0.14_var(--hue))] right-4 text-[0.75rem] opacity-0",
                  { "group-hover:opacity-100": hasBannerLink },
                ]}
                name="fa6-solid:arrow-up-right-from-square"
              />
            </a>
          )
        }

        <SideBar
          class="mb-4 row-start-2 row-end-3 col-span-2 lg:row-start-1 lg:row-end-2 lg:col-span-1 lg:max-w-[17.5rem] onload-animation"
          headings={headings}
        />

        <main
          id="swup-container"
          class="transition-swup-fade col-span-2 lg:col-span-1 xl:col-span-1 overflow-hidden"
        >
          <div id="content-wrapper" class="onload-animation">
            <slot />
            <div class="footer col-span-2 onload-animation hidden lg:block">
              <Footer />
            </div>
          </div>
        </main>

        <div
          class="hidden xl:flex flex-col gap-4 row-start-1 col-start-3 h-fit sticky top-4"
        >
          {
            setOGTypeArticle && (
              <div class="card-base p-6">
                {/* æ ‡é¢˜åŒºåŸŸ */}
                <div class="font-bold text-lg mb-4 ml-1">æ–‡ç« ç›®å½•</div>

                {/* 1. max-h-[60vh]ï¼šé™åˆ¶é«˜åº¦ï¼Œé˜²æ­¢æŠŠå¡ç‰‡æ’‘çˆ† */}
                {/* 2. overflow-y-autoï¼šå†…å®¹å¤šäº†è‡ªåŠ¨å‡ºæ»šåŠ¨æ¡ */}
                {/* 3. pr-2ï¼šå³è¾¹ç•™ç‚¹ç©ºéš™ç»™æ»šåŠ¨æ¡ï¼Œåˆ«è´´ç€å­— */}
                <div class="max-h-[60vh] overflow-y-auto pr-2">
                  <TOC headings={headings} />
                </div>
              </div>
            )
          }
          {/* âœ¨ è¥¿ç“œåŠ©æ‰‹å¡ç‰‡ (ç”±æ‚¬æµ®çƒè½¬ä¸ºä¾§è¾¹æ æ¨¡å—) */}
          <a
            href="/chat/"
            class="card-base group flex items-center gap-4 p-4 cursor-pointer transition-all duration-300 hover:scale-[1.02] hover:shadow-xl hover:border-blue-500/30 onload-animation"
            style="animation-delay: 220ms; text-decoration: none;"
          >
            <div
              class="relative flex items-center justify-center w-12 h-12 rounded-xl bg-gradient-to-br from-blue-100 to-blue-200 dark:from-blue-900/40 dark:to-blue-800/20 text-2xl group-hover:rotate-12 transition-transform duration-300 overflow-hidden border border-white/50 dark:border-white/10"
            >
              <img
                src={coverImg.src}
                alt="AI Avatar"
                class="w-full h-full object-cover opacity-90 group-hover:scale-110 transition-transform duration-500"
              />
              {/* åœ¨çº¿çŠ¶æ€å°ç»¿ç‚¹ */}
              <div
                class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white dark:border-zinc-900"
              >
              </div>
            </div>

            <div class="flex flex-col">
              <div class="flex items-center gap-1.5">
                <span
                  class="font-bold text-base text-gray-900 dark:text-gray-50 leading-tight group-hover:text-blue-500 transition-colors"
                >
                  è¥¿ç“œåŠ©æ‰‹
                </span>
                <span
                  class="px-1.5 py-0.5 rounded-md bg-blue-500/10 text-[10px] text-blue-600 dark:text-blue-400 font-bold tracking-wider"
                  >AI</span
                >
              </div>
              <span class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                æˆ‘æœ‰é—®å¿…ç­”ï¼Œä¸ä¿¡ä½ è¯•è¯•
              </span>
            </div>

            <div
              class="ml-auto text-gray-400 group-hover:text-blue-500 group-hover:translate-x-1 transition-all"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M9 6l6 6l-6 6"></path>
              </svg>
            </div>
          </a>

          {
            !setOGTypeArticle && (
              <>
                <ImageWidget
                  title="å¾®ä¿¡å…¬ä¼—å·"
                  image={mpQrImg.src}
                  class="onload-animation"
                  style="animation-delay: 150ms"
                />

                <ImageWidget
                  title="å¾®ä¿¡å°ç¨‹åº"
                  image={miniQrImg.src}
                  class="onload-animation"
                  style="animation-delay: 200ms"
                />
              </>
            )
          }

          <a
            href="http://shenwan.life/pay/"
            target="_blank"
            class="card-base group flex items-center gap-4 p-4 cursor-pointer transition-all duration-300 hover:scale-[1.02] hover:shadow-xl hover:border-orange-500/30 onload-animation"
            style="animation-delay: 250ms; text-decoration: none;"
          >
            {/* ... è¿™é‡Œçœç•¥æŠ•å–‚æŒ‰é’®çš„å†…éƒ¨ä»£ç  ... */}
            <div
              class="relative flex items-center justify-center w-12 h-12 rounded-xl bg-gradient-to-br from-orange-100 to-orange-200 dark:from-orange-900/40 dark:to-orange-800/20 text-2xl group-hover:rotate-12 transition-transform duration-300"
            >
              ğŸ¬
              <div
                class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white dark:border-zinc-900"
              >
              </div>
            </div>
            <div class="flex flex-col">
              <span
                class="font-bold text-base text-gray-900 dark:text-gray-50 leading-tight group-hover:text-orange-500 transition-colors"
              >
                æŠ•å–‚è¥¿ç“œ
              </span>
              <span class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                æ”¯æŒæœåŠ¡å™¨ & ç»´æŠ¤å¼€å‘
              </span>
            </div>
            <div
              class="ml-auto text-gray-400 group-hover:text-orange-500 group-hover:translate-x-1 transition-all"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <>
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <path d="M9 6l6 6l-6 6"></path>
                </>
              </svg>
            </div>
          </a>
        </div>

        <div class="footer col-span-2 onload-animation block lg:hidden">
          <Footer />
        </div>
      </div>

      <BackToTop />
    </div>
  </div>

  <div class="absolute w-full z-0 hidden 2xl:block">
    <div class="relative max-w-[var(--page-width)] mx-auto">
      {
        /* ğŸ‘‡ ä¿®æ”¹ï¼šå¢åŠ  && !setOGTypeArticle */
        /* æ„æ€æ˜¯ï¼šåªæœ‰åœ¨ã€éæ–‡ç« é¡µã€‘ä¸”æ˜¯å¤§å±å¹•æ—¶ï¼Œæ‰æ˜¾ç¤ºè¿™ä¸ªæ‚¬æµ®ç›®å½• */
        /* å› ä¸ºæ–‡ç« é¡µæˆ‘ä»¬å·²ç»æŠŠå®ƒæ¬åˆ°ä¾§è¾¹æ é‡Œå»äº† */
        siteConfig.toc.enable && !setOGTypeArticle && (
          <div
            id="toc-wrapper"
            class:list={[
              "hidden lg:block transition absolute top-0 -right-[var(--toc-width)] w-[var(--toc-width)] items-center",
              { "toc-hide": siteConfig.banner.enable },
            ]}
          >
            <div
              id="toc-inner-wrapper"
              class="fixed top-14 w-[var(--toc-width)] h-[calc(100vh_-_20rem)] overflow-y-scroll overflow-x-hidden hide-scrollbar"
            >
              <div id="toc" class="w-full h-full transition-swup-fade ">
                <div class="h-8 w-full" />
                <TOC headings={headings} />
                <div class="h-8 w-full" />
              </div>
            </div>
          </div>
        )
      }

      {!siteConfig.toc.enable && <div id="toc" />}
    </div>
  </div>
</Layout>
