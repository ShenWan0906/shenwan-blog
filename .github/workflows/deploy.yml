name: Deploy to Aliyun/Tencent Server

on:
  push:
    branches:
      - main  # ç›‘å¬ main åˆ†æ”¯çš„æäº¤ï¼Œä¸€æ—¦æäº¤å°±è§¦å‘

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # ä½¿ç”¨ GitHub æä¾›çš„è™šæ‹Ÿç¯å¢ƒ

    steps:
    # 1. æ‹‰å–ä»£ç 
    - name: Checkout
      uses: actions/checkout@v4

    # 2. å®‰è£… Node.js å’Œ pnpm
    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install pnpm
      uses: pnpm/action-setup@v3
      with:
        version: 9

    # 3. å®‰è£…ä¾èµ–å¹¶æ„å»º
    - name: Install Dependencies
      run: pnpm install

    - name: Build
      run: pnpm build

    # 4. æŠŠ dist ç›®å½•æ¨é€åˆ°æœåŠ¡å™¨ (ä½¿ç”¨ rsync)
    - name: Deploy to Server
      uses: easingthemes/ssh-deploy@main
      with:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        ARGS: "-avzr --delete"
        SOURCE: "dist/"
        REMOTE_HOST: ${{ secrets.SERVER_IP }}
        REMOTE_USER: ${{ secrets.SERVER_USER }}
        # ğŸ‘‡ è¿™é‡Œä¿®æ”¹ä¸ºä½ æœåŠ¡å™¨ä¸Š Nginx çš„ç½‘ç«™ç›®å½•
        TARGET: "/www/shenwan-blog/" 
        
    # 5. (å¯é€‰) å¦‚æœéœ€è¦é‡å¯ Nginxï¼Œå¯ä»¥åŠ è¿™ä¸€æ­¥
    # - name: Reload Nginx
    #   uses: appleboy/ssh-action@master
    #   with:
    #     host: ${{ secrets.SERVER_IP }}
    #     username: ${{ secrets.SERVER_USER }}
    #     key: ${{ secrets.SSH_PRIVATE_KEY }}
    #     script: nginx -s reload